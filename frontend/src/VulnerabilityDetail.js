import React, { useState, useEffect } from 'react';
import { useParams, Link } from 'react-router-dom';
import './VulnerabilityDetails.css';
import Footer from './Footer';

const VulnerabilityDetails = () => {
  const { id } = useParams();
  const [vulnerability, setVulnerability] = useState(null);

  useEffect(() => {
    fetch(`/api/vulnerabilities/${id}`)
      .then(response => response.json())
      .then(data => setVulnerability(data))
      .catch(error => console.error('Error fetching vulnerability details:', error));
  }, [id]);

  if (!vulnerability) {
    return <div>Loading...</div>;
  }

  const downloadAttachment = (reportId, filename) => {
    fetch(`/api/vulnerabilities/attachments/${reportId}/${filename}`)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.blob();
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      })
      .catch(error => console.error('Error downloading the file:', error));
  };

  return (
    <div>
      <div className="vulnerability-details">
        <h1>{vulnerability.title}</h1>
        <table>
          <tbody>
            <tr>
              <th>Description</th>
              <td>{vulnerability.report_description}</td>
            </tr>
            <tr>
              <th>Artifact Name</th>
              <td>{vulnerability.artifactName}</td>
            </tr>
            <tr>
              <th>Reporter</th>
              <td>{vulnerability.reporterName} ({vulnerability.reporterEmail})</td>
            </tr>
            <tr>
              <th>Organization</th>
              <td>{vulnerability.reporterOrganization}</td>
            </tr>
            <tr>
              <th>Phase</th>
              <td>{vulnerability.phase}</td>
            </tr>
            <tr>
              <th>Phase Description</th>
              <td>{vulnerability.phaseDescription}</td>
            </tr>
            <tr>
              <th>Attributes</th>
              <td>{vulnerability.attributeName}</td>
            </tr>
            <tr>
              <th>Attribute Description</th>
              <td>{vulnerability.attr_Description}</td>
            </tr>
            <tr>
              <th>Effect</th>
              <td>{vulnerability.effectName}</td>
            </tr>
            <tr>
              <th>Effect Description</th>
              <td>{vulnerability.eff_Description}</td>
            </tr>
            {vulnerability.attachments && vulnerability.attachments.length > 0 && (
              <tr>
                <th>Attachments</th>
                <td>
                  {vulnerability.attachments.map((attachment, index) => (
                    <button key={index} onClick={() => downloadAttachment(vulnerability.id, attachment.filename)}>
                      Download {attachment.filename}
                    </button>
                  ))}
                </td>
              </tr>
            )}
          </tbody>
        </table>
        <div className="vulnerability-actions">
          <div className="left-action">
            <Link to="/vulnerabilities/">Back to Vulnerability List</Link>
          </div>
          <div className="right-actions">
            <Link to={`/vulnerabilities/${id}/edit/`}>Edit Details</Link>
            <span> | </span>
            <Link to={`/vulnerabilities/${id}/delete/`}>Delete</Link>
          </div>
        </div>
      </div>
      <Footer />
    </div>
  );
};

export default VulnerabilityDetails;
